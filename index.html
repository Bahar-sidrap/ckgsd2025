<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Skrining Kesehatan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Gaya dasar untuk modal */
        #messageModal {
            display: none;
            /* Sembunyikan secara default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 400px;
            text-align: center;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
        }

        .close-button:hover {
            color: #333;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Gaya untuk tampilan (views) */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Gaya untuk tombol navigasi */
        .nav-buttons button.active {
            @apply bg-blue-600 text-white;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div id="messageModal">
        <div class="modal-content">
            <span class="close-button" onclick="hideMessage()">×</span>
            <div id="loadingSpinner" class="spinner hidden"></div>
            <p id="messageText" class="text-lg"></p>
        </div>
    </div>

    <header class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Skrining Kesehatan Siswa Puskesmas Lawawoi</h1>
            <img src="https://webstoriess.enkosa.com/wp-content/uploads/2024/01/Download-Logo-Kabupaten-Sidenreng-Rappang-PNG.png" alt="Logo Puskesmas" class="h-12">
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">

        <div class="nav-buttons flex flex-wrap gap-2 mb-8">
            <button id="formViewBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-500 hover:text-white transition-colors" onclick="showView('form')">
                <i class="fa-solid fa-plus-circle mr-2"></i>Tambah Data
            </button>
            <button id="listViewBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-500 hover:text-white transition-colors" onclick="showView('list')">
                <i class="fa-solid fa-table mr-2"></i>Data Saya
            </button>
            <button id="rekapViewBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-500 hover:text-white transition-colors" onclick="showView('rekap')">
                <i class="fa-solid fa-chart-bar mr-2"></i>Rekap Data
            </button>
        </div>

        <div id="formView" class="view active bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-800 mb-6">Formulir Skrining Kesehatan</h2>
            <form id="dataSiswaForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <div>
                        <label for="namaSekolah" class="block text-sm font-medium text-gray-700">Nama Satuan Pendidikan</label>
                        <select id="namaSekolah" name="Nama Satuan Pendidikan" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Pilih Sekolah</option>
                            <option value="SDN 1 ARAWA">SDN 1 ARAWA</option>
                            <option value="SDN 2 ARAWA">SDN 2 ARAWA</option>
                            <option value="SDN 3 ARAWA">SDN 3 ARAWA</option>
                            <option value="SDN 4 ARAWA">SDN 4 ARAWA</option>
                            <option value="SDN 5 ARAWA">SDN 5 ARAWA</option>
                            <option value="SDN 6 ARAWA">SDN 6 ARAWA</option>
                            <option value="SDN 7 ARAWA">SDN 7 ARAWA</option>
                            <option value="SDN 8 ARAWA">SDN 8 ARAWA</option>
                            <option value="SDN 9 ARAWA">SDN 9 ARAWA</option>
                            <option value="SDN 10 ARAWA">SDN 10 ARAWA</option>
                            <option value="SDN 1 LAWAWOI">SDN 1 LAWAWOI</option>
                            <option value="SDN 2 LAWAWOI">SDN 2 LAWAWOI</option>
                            <option value="SDN 3 LAWAWOI">SDN 3 LAWAWOI</option>
                            <option value="SDN 4 LAWAWOI">SDN 4 LAWAWOI</option>
                            <option value="SDN 5 LAWAWOI">SDN 5 LAWAWOI</option>
                            <option value="SDN 1 CARAWALI">SDN 1 CARAWALI</option>
                            <option value="SDN 2 CARAWALI">SDN 2 CARAWALI</option>
                            <option value="SDN 3 CARAWALI">SDN 3 CARAWALI</option>
                            <option value="SDN 4 CARAWALI">SDN 4 CARAWALI</option>
                            <option value="SDN 1 LAINUNGAN">SDN 1 LAINUNGAN</option>
                            <option value="SDN 2 LAINUNGAN">SDN 2 LAINUNGAN</option>
                            <option value="SDN 3 LAINUNGAN">SDN 3 LAINUNGAN</option>
                            <option value="SDN 4 LAINUNGAN">SDN 4 LAINUNGAN</option>
                            <option value="SD S IT AL IMAN">SD S IT AL IMAN</option>
                        </select>
                    </div>
                    <div>
                        <label for="kelas" class="block text-sm font-medium text-gray-700">Kelas</label>
                        <select id="kelas" name="Kelas" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Pilih Kelas</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                    <div>
                        <label for="nama" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                        <input type="text" id="nama" name="Nama" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="jenisKelamin" class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                        <select id="jenisKelamin" name="Jenis Kelamin" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">Pilih Jenis Kelamin</option>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label for="nisn" class="block text-sm font-medium text-gray-700">NISN</label>
                        <input type="number" id="nisn" name="NISN" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="nik" class="block text-sm font-medium text-gray-700">NIK</label>
                        <input type="number" id="nik" name="NIK" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="tempatLahir" class="block text-sm font-medium text-gray-700">Tempat Lahir</label>
                        <input type="text" id="tempatLahir" name="Tempat Lahir" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="tanggalLahir" class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                        <input type="date" id="tanggalLahir" name="Tanggal Lahir" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="usia" class="block text-sm font-medium text-gray-700">Usia (Ulang tahun terakhir)</label>
                        <input type="number" id="usia" name="Usia (Ulang tahun terakhir)" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500 shadow-sm sm:text-sm">
                    </div>
                    <div>
                        <label for="alamat" class="block text-sm font-medium text-gray-700">Alamat</label>
                        <input type="text" id="alamat" name="Alamat" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="noHp" class="block text-sm font-medium text-gray-700">No. HP</label>
                        <input type="number" id="noHp" name="No. HP" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                </div>

                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <h3 class="md:col-span-2 lg:col-span-3 text-lg font-semibold text-gray-800">Riwayat Kesehatan</h3>
                    <div>
                        <label for="risikoTuberkulosis" class="block text-sm font-medium text-gray-700">Risiko Tuberkulosis</label>
                        <select id="risikoTuberkulosis" name="Risiko Tuberkulosis" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div>
                        <label for="risikoDiabetesMellitus" class="block text-sm font-medium text-gray-700">Risiko Diabetes Mellitus</label>
                        <select id="risikoDiabetesMellitus" name="Risiko Diabetes Mellitus" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div>
                        <label for="risikoKesehatanJiwa" class="block text-sm font-medium text-gray-700">Risiko Kesehatan Jiwa</label>
                        <select id="risikoKesehatanJiwa" name="Risiko Kesehatan Jiwa" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak Ada">Tidak Ada</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div id="kesehatanReproduksiField" class="hidden">
                        <label for="kesehatanReproduksi" class="block text-sm font-medium text-gray-700">Kesehatan Reproduksi (Kelas 4-6)</label>
                        <select id="kesehatanReproduksi" name="Kesehatan Reproduksi (Kelas 4-6)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div id="merokokContainer" class="hidden">
                        <label for="merokokDalam1TahunTerakhir" class="block text-sm font-medium text-gray-700">Merokok dalam 1 tahun terakhir (Kelas 4-6)</label>
                        <select id="merokokDalam1TahunTerakhir" name="Merokok dalam 1 tahun terakhir" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div id="merokokDetailFields" class="md:col-span-2 hidden grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-100 p-4 rounded-lg">
                        <div>
                            <label for="jenisRokok" class="block text-sm font-medium text-gray-700">Jenis rokok</label>
                            <input type="text" id="jenisRokok" name="Jenis rokok yang dikonsumsi" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="jumlahRokokPerHari" class="block text-sm font-medium text-gray-700">Jumlah rokok per hari</label>
                            <input type="text" id="jumlahRokokPerHari" name="Jumlah rokok per hari" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="lamaMerokok" class="block text-sm font-medium text-gray-700">Lama merokok (dalam tahun)</label>
                            <input type="text" id="lamaMerokok" name="Lama merokok (dalam tahun)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <div id="terpaparAsapRokokField" class="hidden">
                        <label for="terpaparAsapRokok" class="block text-sm font-medium text-gray-700">Terpapar Asap Rokok Orang Lain (Kelas 4-6)</label>
                        <select id="terpaparAsapRokok" name="Terpapar Asap Rokok Orang Lain" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div>
                        <label for="risikoHepatitisB" class="block text-sm font-medium text-gray-700">Risiko Hepatitis B</label>
                        <select id="risikoHepatitisB" name="Risiko Hepatitis B" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div id="aktivitasFisikKuesionerField" class="hidden">
                        <label for="aktivitasFisikKuesioner" class="block text-sm font-medium text-gray-700">Aktivitas Fisik (Kelas 4-6)</label>
                        <select id="aktivitasFisikKuesioner" name="Aktivitas Fisik (kelas 4-6)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Ya">Ya</option>
                            <option value="Tidak">Tidak</option>
                        </select>
                    </div>
                    <div id="parQChildField" class="hidden">
                        <label for="parQChild" class="block text-sm font-medium text-gray-700">Par Q Child (Kelas 4-6)</label>
                        <select id="parQChild" name="Par Q Child (kelas 4-6)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div id="imunisasiKuesionerField" class="hidden">
                        <label for="imunisasiKuesioner" class="block text-sm font-medium text-gray-700">Riwayat Imunisasi Rutin Lengkap (Kelas 4-6)</label>
                        <select id="imunisasiKuesioner" name="Riwayat Imunisasi Rutin Lengkap" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Ya">Ya</option>
                            <option value="Tidak">Tidak</option>
                        </select>
                    </div>
                    <div>
                        <label for="risikoFrambusia" class="block text-sm font-medium text-gray-700">Risiko Frambusia</label>
                        <select id="risikoFrambusia" name="Risiko Frambusia" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div>
                        <label for="risikoKusta" class="block text-sm font-medium text-gray-700">Risiko Kusta</label>
                        <select id="risikoKusta" name="Risiko Kusta" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div>
                        <label for="risikoScabies" class="block text-sm font-medium text-gray-700">Risiko Scabies</label>
                        <select id="risikoScabies" name="Risiko Scabies" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                    <div>
                        <label for="risikoMalaria" class="block text-sm font-medium text-gray-700">Risiko Malaria khusus daerah endemis*</label>
                        <select id="risikoMalaria" name="Risiko Malaria khusus daerah endemis*" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak">Tidak</option>
                            <option value="Ya">Ya</option>
                        </select>
                    </div>
                </div>

                <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <h3 class="md:col-span-2 text-lg font-semibold text-gray-800">Hasil Pemeriksaan</h3>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="tekananDarahSistolik" class="block text-sm font-medium text-gray-700">Sistolik (mmHg)</label>
                            <input type="number" id="tekananDarahSistolik" name="Tekanan Darah Sistolik (mmHg)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="tekananDarahDiastolik" class="block text-sm font-medium text-gray-700">Diastolik (mmHg)</label>
                            <input type="number" id="tekananDarahDiastolik" name="Tekanan Darah Diastolik (mmHg)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="klasifikasiTekananDarah" class="block text-sm font-medium text-gray-700">Klasifikasi Tekanan Darah</label>
                            <select id="klasifikasiTekananDarah" name="Klasifikasi Tekanan Darah" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="">Pilih Klasifikasi</option>
                                <option value="Normal <90/60 mmHg dan <95 persentil">Normal <90/60 mmHg dan <95 persentil</option>
                                <option value="Pre-hipertensi Sistolik 90-120 mmHg dan/atau Diastolik 60-80 mmHg atau >=90 persentil dan <95 persentil">Pre-hipertensi</option>
                                <option value="Hipertensi tingkat 1 Sistolik 120-139 mmHg dan/atau Diastolik 80-89 mmHg atau >=95 persentil dan <99 persentil + 5 mmHg">Hipertensi tingkat 1</option>
                                <option value="Hipertensi tingkat 2 >=140/90 mmHg atau >=99 persentil + 5 mmHg">Hipertensi tingkat 2</option>
                            </select>
                        </div>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="tinggiBadan" class="block text-sm font-medium text-gray-700">Tinggi Badan (cm)</label>
                            <input type="number" id="tinggiBadan" name="Tinggi Badan" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="beratBadan" class="block text-sm font-medium text-gray-700">Berat Badan (kg)</label>
                            <input type="number" id="beratBadan" name="Berat Badan" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="imt" class="block text-sm font-medium text-gray-700">IMT</label>
                            <input type="text" id="imt" name="IMT" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500 shadow-sm sm:text-sm">
                        </div>
                        <div>
                            <label for="penilaianStatusGizi" class="block text-sm font-medium text-gray-700">Penilaian Status Gizi</label>
                            <input type="text" id="penilaianStatusGizi" name="Penilaian Status Gizi" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500 shadow-sm sm:text-sm">
                        </div>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="karies" class="block text-sm font-medium text-gray-700">Karies</label>
                            <select id="karies" name="Karies" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="Tidak">Tidak</option>
                                <option value="Ya">Ya</option>
                            </select>
                        </div>
                        <div>
                            <label for="masalahLainnyaGigi" class="block text-sm font-medium text-gray-700">Masalah lainnya</label>
                            <input type="text" id="masalahLainnyaGigi" name="Masalah lainnya" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="mataLuar" class="block text-sm font-medium text-gray-700">Mata Luar</label>
                            <select id="mataLuar" name="Mata Luar" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="Mata sehat">Mata sehat</option>
                                <option value="Konjungtivitis">Konjungtivitis</option>
                                <option value="Strabismus">Strabismus</option>
                                <option value="Ptosis">Ptosis</option>
                            </select>
                        </div>
                        <div>
                            <label for="gangguanTajamPenglihatan" class="block text-sm font-medium text-gray-700">Gangguan Tajam Penglihatan</label>
                            <select id="gangguanTajamPenglihatan" name="Gangguan Tajam Penglihatan" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="Normal: Visus 6/6 - 6/9">Normal: Visus 6/6 - 6/9</option>
                                <option value="Tidak Normal: Visus 6/12 - 6/60">Tidak Normal: Visus 6/12 - 6/60</option>
                                <option value="Buta: Visus <6/60">Buta: Visus <6/60</option>
                            </select>
                        </div>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="infeksiTelinga" class="block text-sm font-medium text-gray-700">Infeksi (Telinga)</label>
                            <select id="infeksiTelinga" name="Infeksi (Telinga)" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="Tidak">Tidak</option>
                                <option value="Ya">Ya</option>
                            </select>
                        </div>
                        <div>
                            <label for="serumen" class="block text-sm font-medium text-gray-700">Serumen</label>
                            <select id="serumen" name="Serumen" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="Tidak">Tidak</option>
                                <option value="Ya">Ya</option>
                            </select>
                        </div>
                        <div>
                            <label for="gangguanTajamPendengaran" class="block text-sm font-medium text-gray-700">Gangguan Tajam Pendengaran</label>
                            <select id="gangguanTajamPendengaran" name="Gangguan Tajam Pendengaran" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="Dapat mengulang kata lebih dari 80% (minimal 4 dari 5)">Dapat mengulang kata lebih dari 80% (minimal 4 dari 5)</option>
                                <option value="Tidak dapat mengulang kata">Tidak dapat mengulang kata</option>
                            </select>
                        </div>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="waktuKebugaranJasmani" class="block text-sm font-medium text-gray-700">Waktu Kebugaran Jasmani (menit:detik)</label>
                            <input type="text" id="waktuKebugaranJasmani" name="Waktu Kebugaran Jasmani" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: 15:30">
                        </div>
                        <div>
                            <label for="kebugaranJasmani" class="block text-sm font-medium text-gray-700">Kebugaran Jasmani</label>
                            <select id="kebugaranJasmani" name="Kebugaran Jasmani" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="Baik sekali/ Baik">Baik sekali/ Baik</option>
                                <option value="Sedang">Sedang</option>
                                <option value="Kurang">Kurang</option>
                            </select>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label for="kesimpulan" class="block text-sm font-medium text-gray-700">Kesimpulan</label>
                        <select id="kesimpulan" name="Kesimpulan" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="Tidak Rujuk">Tidak Rujuk</option>
                            <option value="Rujuk">Rujuk</option>
                        </select>
                    </div>
                </div>

                <div class="md:col-span-2 mt-4">
                    <button id="submitButton" type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Simpan Data
                    </button>
                </div>
            </form>
        </div>

        <div id="listView" class="view">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Daftar Data Saya (Offline)</h2>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Cari berdasarkan nama..." class="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fa-solid fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>
                <div id="noMyDataMessage" class="text-center text-gray-500 py-10">
                    <i class="fa-solid fa-folder-open text-6xl mb-4"></i>
                    <p class="text-lg">Tidak ada data yang tersimpan secara offline.</p>
                </div>
                <div class="overflow-x-auto">
                    <table id="myStudentTable" class="w-full text-left table-auto hidden">
                        <thead class="bg-gray-50 text-gray-600 text-sm font-semibold uppercase tracking-wider">
                            <tr>
                                <th class="py-3 px-4">No</th>
                                <th class="py-3 px-4 text-center">Status</th>
                                <th class="py-3 px-4">Sekolah</th>
                                <th class="py-3 px-4">Kelas</th>
                                <th class="py-3 px-4">Nama</th>
                                <th class="py-3 px-4"></th>
                            </tr>
                        </thead>
                        <tbody id="myStudentTableBody" class="bg-white divide-y divide-gray-200 text-gray-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="rekapView" class="view">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Rekap Data Global (dari Google Sheet)</h2>

                <div class="flex flex-col sm:flex-row gap-4 mb-6 items-center">
                    <div class="w-full sm:w-1/2">
                        <label for="downloadSekolahSelect" class="block text-sm font-medium text-gray-700">Pilih Sekolah</label>
                        <select id="downloadSekolahSelect" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="all">Semua Sekolah</option>
                        </select>
                    </div>
                    <div class="w-full sm:w-1/4">
                        <label for="downloadKelasSelect" class="block text-sm font-medium text-gray-700">Pilih Kelas</label>
                        <select id="downloadKelasSelect" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="all">Semua Kelas</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                    <div class="w-full sm:w-1/4 self-end mt-4 sm:mt-0">
                        <button onclick="downloadCSV()" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <i class="fa-solid fa-download mr-2"></i>Download CSV
                        </button>
                    </div>
                </div>

                <div id="loadingGlobalDataMessage" class="text-center text-gray-500 py-10 hidden">
                    <i class="fa-solid fa-spinner fa-spin text-6xl mb-4"></i>
                    <p class="text-lg">Memuat data...</p>
                </div>
                <div id="noGlobalDataMessage" class="text-center text-gray-500 py-10 hidden">
                    <i class="fa-solid fa-exclamation-circle text-6xl mb-4"></i>
                    <p class="text-lg">Tidak ada data rekap yang tersedia.</p>
                </div>
                <div class="overflow-x-auto">
                    <table id="globalStudentTable" class="w-full text-left table-auto hidden">
                        <thead class="bg-gray-50 text-gray-600 text-sm font-semibold uppercase tracking-wider">
                            <tr>
                                <th class="py-3 px-4">No</th>
                                <th class="py-3 px-4">Sekolah</th>
                                <th class="py-3 px-4">Kelas</th>
                                <th class="py-3 px-4">Jumlah Data</th>
                            </tr>
                        </thead>
                        <tbody id="globalStudentTableBody" class="bg-white divide-y divide-gray-200 text-gray-700">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-white text-gray-600 text-center py-4 text-sm mt-8">
        © 2025 Aplikasi Skrining Kesehatan Sekolah. Dibuat dengan oleh Baharuddin Puskesmas Lawawoi
    </footer>

<script>
    const REKAP_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx8Vjz3Pc_fQsM73oH_5v5fQAP55PkMtC7sqMTvn2m-Xyk2i4Vx0gF9FXAUQApojcU-Yw/exec?action=getGlobalData';
    const GOOGLE_SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx8Vjz3Pc_fQsM73oH_5v5fQAP55PkMtC7sqMTvn2m-Xyk2i4Vx0gF9FXAUQApojcU-Yw/exec';

    let globalRawData = [];
    let editingTimestamp = null;
    const dom = {
        messageModal: document.getElementById('messageModal'),
        messageText: document.getElementById('messageText'),
        loadingSpinner: document.getElementById('loadingSpinner'),
        formViewBtn: document.getElementById('formViewBtn'),
        listViewBtn: document.getElementById('listViewBtn'),
        rekapViewBtn: document.getElementById('rekapViewBtn'),
        dataSiswaForm: document.getElementById('dataSiswaForm'),
        submitButton: document.getElementById('submitButton'),
        kelasSelect: document.getElementById('kelas'),
        merokokSelect: document.getElementById('merokokDalam1TahunTerakhir'),
        merokokDetailFields: document.getElementById('merokokDetailFields'),
        myStudentTableBody: document.getElementById('myStudentTableBody'),
        myStudentTable: document.getElementById('myStudentTable'),
        noMyDataMessage: document.getElementById('noMyDataMessage'),
        searchInput: document.getElementById('searchInput'),
        globalStudentTableBody: document.getElementById('globalStudentTableBody'),
        globalStudentTable: document.getElementById('globalStudentTable'),
        noGlobalDataMessage: document.getElementById('noGlobalDataMessage'),
        loadingGlobalDataMessage: document.getElementById('loadingGlobalDataMessage'),
        downloadSekolahSelect: document.getElementById('downloadSekolahSelect'),
        downloadKelasSelect: document.getElementById('downloadKelasSelect'),
    };
    
    function showMessage(message, isLoading = false) {
        dom.messageText.textContent = message;
        if (isLoading) {
            dom.loadingSpinner.classList.remove('hidden');
        } else {
            dom.loadingSpinner.classList.add('hidden');
        }
        dom.messageModal.style.display = 'flex';
    }

    function hideMessage() {
        dom.messageModal.style.display = 'none';
    }

    document.querySelector('#messageModal .close-button').addEventListener('click', hideMessage);

    window.addEventListener('click', (event) => {
        if (event.target === dom.messageModal) {
            hideMessage();
        }
    });

    function calculateIMT() {
        const tinggiBadan = parseFloat(document.getElementById('tinggiBadan').value);
        const beratBadan = parseFloat(document.getElementById('beratBadan').value);
        const imtInput = document.getElementById('imt');
        if (tinggiBadan > 0 && beratBadan > 0) {
            const tinggiMeters = tinggiBadan / 100;
            const imt = beratBadan / (tinggiMeters * tinggiMeters);
            imtInput.value = imt.toFixed(2);
            calculateStatusGizi(imt);
        } else {
            imtInput.value = '';
            calculateStatusGizi(null);
        }
    }

    function calculateAge() {
        const tanggalLahirInput = document.getElementById('tanggalLahir').value;
        const usiaInput = document.getElementById('usia');
        if (tanggalLahirInput) {
            const birthDate = new Date(tanggalLahirInput);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDifference = today.getMonth() - birthDate.getMonth();
            if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            usiaInput.value = age;
        } else {
            usiaInput.value = '';
        }
    }

    function calculateStatusGizi(imtValue) {
        const statusGiziSelect = document.getElementById('penilaianStatusGizi');
        if (imtValue === null || isNaN(imtValue)) {
            statusGiziSelect.value = '';
            return;
        }
        if (imtValue < 14) {
            statusGiziSelect.value = 'Gizi Buruk <-3SD';
        } else if (imtValue >= 14 && imtValue < 16) {
            statusGiziSelect.value = 'Gizi Kurang -3SD s/d <-2SD';
        } else if (imtValue >= 16 && imtValue <= 20) {
            statusGiziSelect.value = 'Normal -2SD s/d +1SD';
        } else if (imtValue > 20 && imtValue <= 23) {
            statusGiziSelect.value = 'Gizi Lebih >+1SD s/d +2SD';
        } else if (imtValue > 23) {
            statusGiziSelect.value = 'Obesitas >+2SD';
        } else {
            statusGiziSelect.value = '';
        }
    }
    
    function calculateKlasifikasiTekananDarah() {
        const sistolik = parseFloat(document.getElementById('tekananDarahSistolik').value);
        const diastolik = parseFloat(document.getElementById('tekananDarahDiastolik').value);
        const klasifikasiSelect = document.getElementById('klasifikasiTekananDarah');
        
        let selectedValue = '';
        if (isNaN(sistolik) || isNaN(diastolik)) {
            selectedValue = '';
        } else if (sistolik < 90 && diastolik < 60) {
            selectedValue = 'Normal <90/60 mmHg dan <95 persentil';
        } else if ((sistolik >= 90 && sistolik <= 120) || (diastolik >= 60 && diastolik <= 80)) {
            selectedValue = 'Pre-hipertensi Sistolik 90-120 mmHg dan/atau Diastolik 60-80 mmHg atau >=90 persentil dan <95 persentil';
        } else if ((sistolik >= 120 && sistolik <= 139) || (diastolik >= 80 && diastolik <= 89)) {
            selectedValue = 'Hipertensi tingkat 1 Sistolik 120-139 mmHg dan/atau Diastolik 80-89 mmHg atau >=95 persentil dan <99 persentil + 5 mmHg';
        } else if (sistolik >= 140 || diastolik >= 90) {
            selectedValue = 'Hipertensi tingkat 2 >=140/90 mmHg atau >=99 persentil + 5 mmHg';
        }

        klasifikasiSelect.value = selectedValue;
    }
    
    function toggleConditionalFields() {
        const selectedClass = parseInt(dom.kelasSelect.value);
        const conditionalFields = ['kesehatanReproduksiField', 'merokokContainer', 'terpaparAsapRokokField', 'aktivitasFisikKuesionerField', 'parQChildField', 'imunisasiKuesionerField'];

        conditionalFields.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            if (element) {
                if (selectedClass >= 4 && selectedClass <= 6) {
                    element.classList.remove('hidden');
                } else {
                    element.classList.add('hidden');
                }
            }
        });
        
        const merokokValue = dom.merokokSelect.value;
        if (selectedClass >= 4 && selectedClass <= 6 && merokokValue === 'Ya') {
            dom.merokokDetailFields.classList.remove('hidden');
        } else {
            dom.merokokDetailFields.classList.add('hidden');
        }
    }
    
    function saveDataToLocalStorage(data) {
        try {
            let storedData = JSON.parse(localStorage.getItem('formDataSD')) || [];
            storedData.push(data);
            localStorage.setItem('formDataSD', JSON.stringify(storedData));
            showMessage('Data berhasil disimpan secara offline!');
        } catch (error) {
            console.error('Gagal menyimpan data ke Local Storage:', error);
            showMessage('Terjadi kesalahan saat menyimpan data secara offline.');
        }
    }
    
    async function sendDataToGoogleSheets(data, retries = 3, delay = 1000) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                // Karena 'no-cors', response.ok akan selalu false. Kita asumsikan berhasil.
                // Logika ini harus diubah jika kita bisa menggunakan cors.
                return true;
            } catch (error) {
                console.error(`Percobaan ${i + 1} gagal mengirim data:`, error);
                if (i < retries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }
        return false;
    }

    async function syncDataToGoogleSheets() {
        let storedData = JSON.parse(localStorage.getItem('formDataSD')) || [];
        if (storedData.length === 0) return;
        
        showMessage('Menyinkronkan data...', true);
        let updatedData = [];
        let successfulSyncs = 0;

        for (const item of storedData) {
            if (!item.isSynced) {
                const success = await sendDataToGoogleSheets(item);
                if (success) {
                    item.isSynced = true;
                    successfulSyncs++;
                }
            }
            updatedData.push(item);
        }
        
        localStorage.setItem('formDataSD', JSON.stringify(updatedData));
        
        if (successfulSyncs > 0) {
            showMessage(`Sinkronisasi selesai. ${successfulSyncs} data berhasil dikirim.`);
        } else {
            hideMessage();
        }
        loadMyDataList();
    }

    function checkOnlineStatusAndSync() {
        if (navigator.onLine) {
            let storedData = JSON.parse(localStorage.getItem('formDataSD')) || [];
            const unsyncedDataExists = storedData.some(item => !item.isSynced);
            if (unsyncedDataExists) {
                syncDataToGoogleSheets();
            }
        }
    }
    
    function resetFormToDefaults() {
        dom.dataSiswaForm.reset();
        document.getElementById('risikoTuberkulosis').value = 'Tidak';
        document.getElementById('risikoDiabetesMellitus').value = 'Tidak';
        document.getElementById('risikoKesehatanJiwa').value = 'Tidak Ada';
        document.getElementById('kesehatanReproduksi').value = 'Tidak';
        document.getElementById('merokokDalam1TahunTerakhir').value = 'Tidak';
        document.getElementById('terpaparAsapRokok').value = 'Tidak';
        document.getElementById('risikoHepatitisB').value = 'Tidak';
        document.getElementById('aktivitasFisikKuesioner').value = 'Ya';
        document.getElementById('parQChild').value = 'Tidak';
        document.getElementById('imunisasiKuesioner').value = 'Ya';
        document.getElementById('risikoFrambusia').value = 'Tidak';
        document.getElementById('risikoKusta').value = 'Tidak';
        document.getElementById('risikoScabies').value = 'Tidak';
        document.getElementById('risikoMalaria').value = 'Tidak';
        document.getElementById('klasifikasiTekananDarah').value = '';
        document.getElementById('penilaianStatusGizi').value = '';
        document.getElementById('karies').value = 'Tidak';
        document.getElementById('mataLuar').value = 'Mata sehat';
        document.getElementById('gangguanTajamPenglihatan').value = 'Normal: Visus 6/6 - 6/9';
        document.getElementById('infeksiTelinga').value = 'Tidak';
        document.getElementById('serumen').value = 'Tidak';
        document.getElementById('gangguanTajamPendengaran').value = 'Dapat mengulang kata lebih dari 80% (minimal 4 dari 5)';
        document.getElementById('kebugaranJasmani').value = 'Baik sekali/ Baik';
        document.getElementById('kesimpulan').value = 'Tidak Rujuk';

        document.getElementById('imt').value = '';
        document.getElementById('usia').value = '';
        document.getElementById('tekananDarahSistolik').value = '';
        document.getElementById('tekananDarahDiastolik').value = '';
        document.getElementById('waktuKebugaranJasmani').value = '';
        document.getElementById('namaSekolah').value = '';
        document.getElementById('kelas').value = '';
        
        toggleConditionalFields();
    }

    dom.dataSiswaForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }

        if (data['NISN'] && data['NISN'].length > 0) {
            data['NISN'] = `'` + data['NISN'];
        }
        if (data['NIK'] && data['NIK'].length > 0) {
            data['NIK'] = `'` + data['NIK'];
        }
        if (data['No. HP'] && data['No. HP'].length > 0) {
            data['No. HP'] = `'` + data['No. HP'];
        }

        let storedData = JSON.parse(localStorage.getItem('formDataSD')) || [];
        
        if (editingTimestamp !== null) {
            const indexToUpdate = storedData.findIndex(item => item.timestamp === editingTimestamp);
            if (indexToUpdate !== -1) {
                const oldTimestamp = storedData[indexToUpdate].timestamp;
                data['timestamp'] = oldTimestamp;
                data['isSynced'] = false;
                storedData[indexToUpdate] = data;
                showMessage('Data berhasil diperbarui secara offline!');
            }
        } else {
            data['isSynced'] = false;
            data['timestamp'] = new Date().toISOString();
            storedData.push(data);
            showMessage('Data berhasil disimpan secara offline!');
        }

        localStorage.setItem('formDataSD', JSON.stringify(storedData));
        editingTimestamp = null;
        dom.submitButton.textContent = 'Simpan Data';

        if (navigator.onLine) {
            await syncDataToGoogleSheets();
        }

        resetFormToDefaults();
        loadMyDataList();
        showView('list');
    });
    
    function searchMyData() {
        const searchTerm = dom.searchInput.value.toLowerCase();
        let storedData = JSON.parse(localStorage.getItem('formDataSD')) || [];

        if (searchTerm === '') {
            loadMyDataList();
            return;
        }

        const filteredData = storedData.filter(data => 
            data.Nama.toLowerCase().includes(searchTerm)
        );
        
        loadMyDataList(filteredData);
    }
    
    function loadMyDataList(dataToDisplay = null) {
        dom.myStudentTableBody.innerHTML = '';
        const storedData = JSON.parse(localStorage.getItem('formDataSD')) || [];
        const displayData = dataToDisplay || storedData;

        if (displayData.length === 0) {
            dom.noMyDataMessage.classList.remove('hidden');
            dom.myStudentTable.classList.add('hidden');
        } else {
            dom.noMyDataMessage.classList.add('hidden');
            dom.myStudentTable.classList.remove('hidden');
            displayData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            displayData.forEach((data, index) => {
                const statusIcon = data.isSynced
                    ? `<i class="fa-solid fa-circle-check text-green-500" title="Tersimpan di Sheet"></i>`
                    : `<i class="fa-solid fa-cloud-arrow-up text-gray-400" title="Belum tersimpan"></i>`;
                
                const row = dom.myStudentTableBody.insertRow();
                row.classList.add('hover:bg-gray-100', 'cursor-pointer');
                row.setAttribute('onclick', `editData('${data.timestamp}')`);
                row.innerHTML = `
                    <td class="py-3 px-4">${index + 1}</td>
                    <td class="py-3 px-4 text-center">${statusIcon}</td>
                    <td class="py-3 px-4">${data['Nama Satuan Pendidikan'] || ''}</td>
                    <td class="py-3 px-4">${data['Kelas'] || ''}</td>
                    <td class="py-3 px-4">${data['Nama'] || ''}</td>
                    <td class="py-3 px-4 text-right">
                        <button onclick="event.stopPropagation(); deleteData('${data.timestamp}')" class="text-red-500 hover:text-red-700">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </td>
                `;
            });
        }
    }
    
    function editData(timestamp) {
        let storedData = JSON.parse(localStorage.getItem('formDataSD')) || [];
        const dataToEdit = storedData.find(item => item.timestamp === timestamp);
        if (!dataToEdit) return;

        editingTimestamp = timestamp;
        dom.submitButton.textContent = 'Update Data';

        for (const key in dataToEdit) {
            const element = document.getElementById(getFormElementId(key));
            if (element) {
                if (['NISN', 'NIK', 'No. HP'].includes(key) && typeof dataToEdit[key] === 'string' && dataToEdit[key].startsWith("'")) {
                    element.value = dataToEdit[key].substring(1);
                } else {
                    element.value = dataToEdit[key];
                }
            }
        }
        
        toggleConditionalFields();
        showView('form');
    }
    
    function deleteData(timestamp) {
        if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) {
            return;
        }

        let storedData = JSON.parse(localStorage.getItem('formDataSD')) || [];
        const newData = storedData.filter(item => item.timestamp !== timestamp);
        localStorage.setItem('formDataSD', JSON.stringify(newData));
        loadMyDataList();
        showMessage('Data berhasil dihapus.');
    }

    function getFormElementId(key) {
        const keyMap = {
            'Nama Satuan Pendidikan': 'namaSekolah', 'Nama': 'nama', 'Jenis Kelamin': 'jenisKelamin',
            'Kelas': 'kelas', 'NISN': 'nisn', 'NIK': 'nik', 'Tempat Lahir': 'tempatLahir',
            'Tanggal Lahir': 'tanggalLahir', 'Usia (Ulang tahun terakhir)': 'usia', 'Alamat': 'alamat',
            'No. HP': 'noHp', 'Risiko Tuberkulosis': 'risikoTuberkulosis',
            'Risiko Diabetes Mellitus': 'risikoDiabetesMellitus', 'Risiko Kesehatan Jiwa': 'risikoKesehatanJiwa',
            'Kesehatan Reproduksi (Kelas 4-6)': 'kesehatanReproduksi',
            'Merokok dalam 1 tahun terakhir': 'merokokDalam1TahunTerakhir',
            'Jenis rokok yang dikonsumsi': 'jenisRokok', 'Jumlah rokok per hari': 'jumlahRokokPerHari',
            'Lama merokok (dalam tahun)': 'lamaMerokok', 'Terpapar Asap Rokok Orang Lain': 'terpaparAsapRokok',
            'Risiko Hepatitis B': 'risikoHepatitisB', 'Aktivitas Fisik (kelas 4-6)': 'aktivitasFisikKuesioner',
            'Par Q Child (kelas 4-6)': 'parQChild', 'Riwayat Imunisasi Rutin Lengkap': 'imunisasiKuesioner',
            'Risiko Frambusia': 'risikoFrambusia', 'Risiko Kusta': 'risikoKusta', 'Risiko Scabies': 'risikoScabies',
            'Risiko Malaria khusus daerah endemis*': 'risikoMalaria',
            'Tekanan Darah Sistolik (mmHg)': 'tekananDarahSistolik',
            'Tekanan Darah Diastolik (mmHg)': 'tekananDarahDiastolik',
            'Klasifikasi Tekanan Darah': 'klasifikasiTekananDarah', 'Tinggi Badan': 'tinggiBadan',
            'Berat Badan': 'beratBadan', 'IMT': 'imt', 'Penilaian Status Gizi': 'penilaianStatusGizi',
            'Karies': 'karies', 'Masalah lainnya': 'masalahLainnyaGigi', 'Mata Luar': 'mataLuar',
            'Gangguan Tajam Penglihatan': 'gangguanTajamPenglihatan', 'Infeksi (Telinga)': 'infeksiTelinga',
            'Serumen': 'serumen', 'Gangguan Tajam Pendengaran': 'gangguanTajamPendengaran',
            'Waktu Kebugaran Jasmani': 'waktuKebugaranJasmani', 'Kebugaran Jasmani': 'kebugaranJasmani',
            'Kesimpulan': 'kesimpulan'
        };
        return keyMap[key] || key;
    }

    async function fetchGlobalData() {
        dom.globalStudentTable.classList.add('hidden');
        dom.noGlobalDataMessage.classList.add('hidden');
        dom.loadingGlobalDataMessage.classList.remove('hidden');

        try {
            const response = await fetch(REKAP_WEB_APP_URL, { method: 'GET', mode: 'cors' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            globalRawData = data;
            dom.loadingGlobalDataMessage.classList.add('hidden');
            populateSchoolDropdown(globalRawData);
            filterAndDisplayRecap();
        } catch (error) {
            console.error('Gagal mengambil data global:', error);
            dom.loadingGlobalDataMessage.classList.add('hidden');
            dom.noGlobalDataMessage.textContent = `Gagal memuat data global: ${error.message}`;
            dom.noGlobalDataMessage.classList.remove('hidden');
        }
    }

    function populateSchoolDropdown(data) {
        dom.downloadSekolahSelect.innerHTML = `<option value="all">Semua Sekolah</option>`;
        const uniqueSchools = [...new Set(data.map(item => item['Nama Satuan Pendidikan']))];
        uniqueSchools.forEach(school => {
            if (school) {
                const option = document.createElement('option');
                option.value = school;
                option.textContent = school;
                dom.downloadSekolahSelect.appendChild(option);
            }
        });
    }

    function filterAndDisplayRecap() {
        const selectedSchool = dom.downloadSekolahSelect.value;
        const selectedClass = dom.downloadKelasSelect.value;

        const filteredData = globalRawData.filter(item => {
            const schoolMatch = (selectedSchool === 'all' || item['Nama Satuan Pendidikan'] === selectedSchool);
            const classMatch = (selectedClass === 'all' || (item['Kelas'] && item['Kelas'].toString() === selectedClass));
            return schoolMatch && classMatch;
        });
        
        const rekapData = filteredData.reduce((acc, current) => {
            if (current['Nama Satuan Pendidikan'] && current['Kelas']) {
                const key = `${current['Nama Satuan Pendidikan']}-${current['Kelas']}`;
                if (!acc[key]) {
                    acc[key] = {
                        'Nama Satuan Pendidikan': current['Nama Satuan Pendidikan'],
                        'Kelas': current['Kelas'],
                        'Jumlah Data': 0
                    };
                }
                acc[key]['Jumlah Data']++;
            }
            return acc;
        }, {});

        displayRecapTable(rekapData);
    }
    
    function displayRecapTable(rekapData) {
        dom.globalStudentTableBody.innerHTML = '';
        if (Object.keys(rekapData).length > 0) {
            dom.globalStudentTable.classList.remove('hidden');
            dom.noGlobalDataMessage.classList.add('hidden');
            let index = 1;
            for (const key in rekapData) {
                const item = rekapData[key];
                const row = dom.globalStudentTableBody.insertRow();
                row.innerHTML = `
                    <td class="py-3 px-4">${index++}</td>
                    <td class="py-3 px-4">${item['Nama Satuan Pendidikan'] || ''}</td>
                    <td class="py-3 px-4">${item['Kelas'] || ''}</td>
                    <td class="py-3 px-4">${item['Jumlah Data'] || 0}</td>
                `;
            }
        } else {
            dom.globalStudentTable.classList.add('hidden');
            dom.noGlobalDataMessage.textContent = 'Tidak ada data yang cocok dengan filter yang dipilih.';
            dom.noGlobalDataMessage.classList.remove('hidden');
        }
    }
    
    function downloadCSV() {
        if (globalRawData.length === 0) {
            showMessage('Tidak ada data yang dapat diunduh.');
            return;
        }

        const selectedSchool = dom.downloadSekolahSelect.value;
        const selectedClass = dom.downloadKelasSelect.value;
        const filteredData = globalRawData.filter(item => {
            const schoolMatch = (selectedSchool === 'all' || item['Nama Satuan Pendidikan'] === selectedSchool);
            const classMatch = (selectedClass === 'all' || (item['Kelas'] && item['Kelas'].toString() === selectedClass));
            return schoolMatch && classMatch;
        });
        
        if (filteredData.length === 0) {
            showMessage('Tidak ada data yang cocok dengan kriteria yang dipilih.');
            return;
        }

        const headers = Object.keys(filteredData[0]).filter(key => key !== 'isSynced' && key !== 'timestamp');
        const csvRows = [
            headers.map(header => `"${header.replace(/"/g, '""')}"`).join(',')
        ];

        for (const item of filteredData) {
            const values = headers.map(header => {
                const value = item[header];
                if (value === null || value === undefined) return '""';
                const stringValue = String(value);
                return `"${stringValue.replace(/"/g, '""')}"`;
            });
            csvRows.push(values.join(','));
        }
        
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        let fileName = 'data_kuesioner_global';
        if (selectedSchool !== 'all') {
            fileName += `_${selectedSchool.replace(/ /g, '_')}`;
        }
        if (selectedClass !== 'all') {
            fileName += `_Kelas_${selectedClass}`;
        }
        fileName += '.csv';

        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showMessage('File CSV berhasil diunduh.');
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.querySelectorAll('.nav-buttons button').forEach(button => button.classList.remove('active'));

        const viewElement = document.getElementById(viewId + 'View');
        if (viewElement) viewElement.classList.add('active');
        
        let activeBtnId = '';
        if (viewId === 'list') {
            activeBtnId = 'listViewBtn';
            editingTimestamp = null;
            dom.submitButton.textContent = 'Simpan Data';
        } else if (viewId === 'rekap') {
            activeBtnId = 'rekapViewBtn';
        } else if (viewId === 'form') {
            activeBtnId = 'formViewBtn';
        }
        
        const activeBtn = document.getElementById(activeBtnId);
        if (activeBtn) activeBtn.classList.add('active');
        
        if (viewId === 'list') {
            loadMyDataList();
        } else if (viewId === 'rekap') {
            fetchGlobalData();
        } else if (viewId === 'form') {
            if (editingTimestamp === null) {
               resetFormToDefaults();
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('tinggiBadan').addEventListener('input', calculateIMT);
        document.getElementById('beratBadan').addEventListener('input', calculateIMT);
        document.getElementById('tanggalLahir').addEventListener('change', calculateAge);
        document.getElementById('tekananDarahSistolik').addEventListener('input', calculateKlasifikasiTekananDarah);
        document.getElementById('tekananDarahDiastolik').addEventListener('input', calculateKlasifikasiTekananDarah);

        dom.kelasSelect.addEventListener('change', toggleConditionalFields);
        dom.merokokSelect.addEventListener('change', toggleConditionalFields);

        dom.searchInput.addEventListener('input', searchMyData);
        
        dom.downloadSekolahSelect.addEventListener('change', filterAndDisplayRecap);
        dom.downloadKelasSelect.addEventListener('change', filterAndDisplayRecap);

        showView('form');
        checkOnlineStatusAndSync();
    });

</script>

</body>
</html>
